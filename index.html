<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<!-- favicon（SVGを推し。古い環境は ICO も同梱しておくと安心） -->
<link rel="icon" href="/icon.ico" type="image/svg+xml">
<link rel="alternate icon" href="/icon.ico" />

<!-- PWAマニフェスト -->
<link rel="manifest" href="/manifest.webmanifest">

<!-- AndroidのUIカラー -->
<meta name="theme-color" content="#111111">

<title>Study Watcher Pro</title>
<style>
  :root { color-scheme: light dark; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
    background: Canvas; color: CanvasText;
  }

  /* 普段は縦向き（ポートレート）前提のレイアウト */
  header { padding: 12px 16px; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: inherit; z-index: 2; }
  main { padding: 12px 16px; }
  .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
  video { width: 100%; max-height: 44vh; background: #000; border-radius: 12px; }
  .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid #ccc; font-size: 14px; }
  .ok { background: #257c4b; border-color: #a3d8bf; }
  .ng { background: #9f2121; border-color: #f2b7b7; }
  button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; background: ButtonFace; color: ButtonText; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
  small { color: #666; }
  #log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; opacity: .85; }
  details summary { cursor: pointer; }

  /* 全画面中は横向きレイアウト（Landscape）に切り替え */
  body.fs header { display: none; }
  body.fs main {
    /* top-pills 分の上余白（安全領域も考慮） */
    padding-top: calc(44px + env(safe-area-inset-top, 0px));
    padding-left: 12px; padding-right: 12px; padding-bottom: 8px;
    display: grid;
    grid-template-columns: 1.4fr 1fr;  /* 左:映像 / 右:操作&ログ */
    gap: 12px;
    align-items: start;
  }
  body.fs video {
    max-height: none;
    height: 100vh;
    border-radius: 0;
  }
  body.fs .floating-bar {
    position: fixed;
    bottom: calc(20px + env(safe-area-inset-bottom, 0px)); /* かぶり防止 */
    left: 0; right: 0;
    display: flex; gap: 8px; justify-content: center;
    z-index: 5;
  }
  body.fs .floating-bar button { opacity: .9; backdrop-filter: blur(6px); }

  /* 全画面時の簡易ヘッダー（横スクロール可） */
  .top-pills { display: none; }
  body.fs .top-pills {
    display: flex; gap: 8px; padding: 8px 12px;
    border-bottom: 1px solid #ddd;
    overflow-x: auto; white-space: nowrap;
    position: fixed; top: 0; left: 0; right: 0;
    background: inherit; z-index: 3;
    height: 44px; /* 高さを明示 */
  }

  /* 端末が横向きロック不可の時に出すトースト */
  .toast {
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
    background: rgba(0,0,0,.7); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 14px;
    z-index: 6; display: none;
  }
  .toast.show { display: block; }

  /* 小さめ端末での微修正 */
  @media (max-width: 360px) {
    .pill { font-size: 12px; padding: 4px 8px; }
    .grid { gap: 8px; }
  }
</style>

</head>
<body>
<header>
  <div class="row">
    <strong>Study Watcher Pro</strong>
    <span id="statePill" class="pill ng">停止中</span>
    <span id="personPill" class="pill">人: 未検出</span>
    <span id="phonePill" class="pill">スマホ: 未検出</span>
    <!--<span id="scorePill" class="pill">スコア: 0</span>  -->
    <span id="minutePill" class="pill">勉強分: 0</span>
  </div>
</header>

<!-- 全画面時の上部ステータス帯（横スクロール可） -->
<div class="top-pills">
  <span id="statePill_fs"  class="pill ng">停止中</span>
  <span id="personPill_fs" class="pill">人: 未検出</span>
  <span id="phonePill_fs"  class="pill">スマホ: 未検出</span>
  <!--<span id="scorePill_fs"  class="pill">スコア: 0</span>  -->
  <span id="minutePill_fs" class="pill">勉強分数: 0</span>
</div>

<main>
  <video id="video" playsinline muted></video>
  <div class="grid">
    <button id="startBtn">開始</button>
    <button id="stopBtn" disabled>停止</button>
    <label class="pill">在席しきい値: <input id="presence" type="number" min="50" max="100" step="5" value="70" style="width:64px;">%</label>
    <label class="pill">送信間隔: <input id="flush" type="number" min="1" max="30" step="1" value="1" style="width:64px;">分</label>
    <button id="fsBtn" class="pill" title="全画面にする">全画面</button>
  </div>

  <p><small>Hint：全画面にすると横向きに切り替わります。</small></p>
  <br><p><small>ver.1.22</small></p><!--version-->
  <details>
    <summary>Log</summary>
    <div id="log"></div>
  </details>
</main>

<!-- 全画面時のフッター操作バー -->
<div class="floating-bar" style="display:none;">
  <button id="fsStart">開始</button>
  <button id="fsStop" disabled>停止</button>
  <button id="fsExit">全画面解除</button>
</div>

<div id="toast" class="toast">横向きにしてください（端末の回転ロックを解除）</div>

<script>
/* ====== GAS WebアプリURLをセット（/exec で終わる） ====== */
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby2tE_Xq1tm_NSDQVQYB52gIEb4_T5DxrYoYkbYbgdV-djRMFuFcqengAP9aWOhlKW4/exec";
/* ======================================================= */

const ui = {
  video: document.getElementById('video'),
  startBtn: document.getElementById('startBtn'),
  stopBtn: document.getElementById('stopBtn'),
  statePill: document.getElementById('statePill'),
  personPill: document.getElementById('personPill'),
  phonePill: document.getElementById('phonePill'),
  scorePill: document.getElementById('scorePill'),
  minutePill: document.getElementById('minutePill'),
  // 全画面帯
  statePill_fs:  document.getElementById('statePill_fs'),
  personPill_fs: document.getElementById('personPill_fs'),
  phonePill_fs:  document.getElementById('phonePill_fs'),
  scorePill_fs:  document.getElementById('scorePill_fs'),
  minutePill_fs: document.getElementById('minutePill_fs'),
  // 入力
  presence: document.getElementById('presence'),
  flush: document.getElementById('flush'),
  // そのほか
  log: document.getElementById('log'),
  fsBtn: document.getElementById('fsBtn'),
  fsBar: document.querySelector('.floating-bar'),
  fsStart: document.getElementById('fsStart'),
  fsStop: document.getElementById('fsStop'),
  fsExit: document.getElementById('fsExit'),
  toast: document.getElementById('toast'),
};

let stream=null, wakeLock=null, running=false;
let tickTimer=null, flushTimer=null;
let model=null;

/* 表示用の合計と、未送信バッファを分離 */
let samples=0, studySamples=0;
let totalMinutes  = Number(sessionStorage.getItem('totalMinutes')  || 0);  // 画面表示に使う累計
let unsentMinutes = Number(localStorage.getItem('unsentMinutes') || 0);  // サーバへ送る未送信分
syncMinutePills();

/* 旧キーからの移行（初回のみ） */
if (localStorage.getItem('studiedMinutes') != null && !localStorage.getItem('totalMinutes')) {
  const old = Number(localStorage.getItem('studiedMinutes')||0);
  totalMinutes = old; unsentMinutes = 0;
  localStorage.removeItem('studiedMinutes');
  sessionStorage.setItem('totalMinutes', String(totalMinutes));
  localStorage.setItem('unsentMinutes','0');
  syncMinutePills();
}

/* ========== 依存（TFJS + COCO-SSD）読み込み（CDN多段） ========== */
async function loadScriptTry(urls){
  let lastErr;
  for (const src of urls){
    try{
      await new Promise((res, rej)=>{
        const s=document.createElement('script');
        s.src=src; s.defer=true; s.onload=res;
        s.onerror=()=>rej(new Error('load failed: '+src));
        document.head.appendChild(s);
      });
      log('loaded: ' + src);
      return;
    }catch(e){ lastErr=e; log('CDN load error: '+src); }
  }
  throw lastErr || new Error('all CDN failed');
}
async function loadDeps(){
  await loadScriptTry([
    'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js',
    'https://unpkg.com/@tensorflow/tfjs@4.15.0/dist/tf.min.js'
  ]);
  await loadScriptTry([
    'https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js',
    'https://unpkg.com/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js'
  ]);
}

/* ========== ボタン ========== */
ui.startBtn.addEventListener('click', start);
ui.stopBtn.addEventListener('click', stop);
ui.fsStart.addEventListener('click', start);
ui.fsStop .addEventListener('click', stop);
ui.fsBtn.addEventListener('click', enterFullscreen);
ui.fsExit.addEventListener('click', exitFullscreen);

/* ========== 全画面＆横向きロック ========== */
async function enterFullscreen(){
  try {
    if (!document.fullscreenElement) {
      if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
      else if (document.body.requestFullscreen)       await document.body.requestFullscreen();
    }
  } catch {}
  document.body.classList.add('fs');
  ui.fsBar.style.display = 'flex';

  // 可能なら横向きにロック（多くの端末で全画面中のみ許可）
  try {
    if (screen.orientation && screen.orientation.lock) {
      await screen.orientation.lock('landscape');
    } else {
      showToast('横向きにしてください（端末の回転ロックを解除）');
    }
  } catch {
    showToast('横向きにしてください（端末の回転ロックを解除）');
  }
}
async function exitFullscreen(){
  try { if (document.fullscreenElement) await document.exitFullscreen(); } catch {}
  document.body.classList.remove('fs');
  ui.fsBar.style.display = 'none';
  try { if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('portrait'); } catch {}
}

/* ========== 開始/停止 ========== */
async function start(){
  if (running) return;
  running = true;
  ui.startBtn.disabled = true;
  ui.stopBtn.disabled = false;
  ui.fsStart.disabled = true;
  ui.fsStop.disabled = false;
  setState(true);

  // 1) カメラ
  try {
    log('[1] starting camera...');
    await startCamera();
    log('[1] camera ready');
  } catch (e) {
    log('NG at camera: ' + (e?.message || e));
    setState(false);
    ui.startBtn.disabled=false; ui.stopBtn.disabled=true;
    ui.fsStart.disabled=false; ui.fsStop.disabled=true;
    running=false;
    return;
  }

  // 2) 依存
  try { log('[2] loading deps...'); await loadDeps(); log('[2] deps loaded'); }
  catch(e){ log('NG at loadDeps: ' + (e?.message||e) + '（在席のみで継続）'); }

  // 3) モデル
  try {
    log('[3] loading model...');
    model = await window.cocoSsd.load({base:'lite_mobilenet_v2'}); // 軽量
    log('[3] model ready');
  } catch(e){
    log('NG at model load: ' + (e?.message||e) + '（在席のみで継続）');
  }

  try { await requestWakeLock(); } catch {}
  tickTimer = setInterval(tick, 1000);  // 1秒ごと推論
  scheduleFlush();                      // 1分ごと送信（UI変更可）
  log('STARTED');
}

async function stop(){
  running=false;
  clearInterval(tickTimer); clearInterval(flushTimer);
  await releaseWakeLock();
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  ui.video.srcObject=null;
  setState(false);
  ui.startBtn.disabled=false; ui.stopBtn.disabled=true;
  ui.fsStart.disabled=false; ui.fsStop.disabled=true;
  await flushReport(true); // 残り送信
  log('STOPPED');
}

/* ========== カメラ ========== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:'user', width:{ideal:640}, height:{ideal:480} }, audio:false
  });
  ui.video.srcObject=stream; await ui.video.play();
}

/* ========== 毎秒の判定 ========== */
async function tick(){
  if(!running) return;
  samples++;

  let hasPerson=false, hasPhone=false;

  try{
    if (model) {
      const preds = await model.detect(ui.video);
      hasPerson = preds.some(p => p.class === 'person' && p.score >= 0.6);
      hasPhone  = preds.some(p => (p.class === 'cell phone' || p.class === 'mobile phone') && p.score >= 0.6);
    } else {
      // モデル無しなら在席のみ（映像が流れていれば在席）
      hasPerson = !!ui.video.srcObject;
      hasPhone  = false;
    }
  }catch(e){
    // 推論失敗は握りつぶして継続
  }

  setPill(ui.personPill,    '人', hasPerson);
  setPill(ui.personPill_fs, '人', hasPerson);
  setPill(ui.phonePill,     'スマホ', hasPhone);
  setPill(ui.phonePill_fs,  'スマホ', hasPhone);

  const base = hasPerson ? 100 : 0;
  const penalty = hasPhone ? 40 : 0;
  const score = Math.max(0, Math.min(100, base - penalty));
  ui.scorePill.textContent = `スコア: ${score}`;
  ui.scorePill_fs.textContent = `スコア: ${score}`;

  if (score >= 60) studySamples++;

  if (samples >= 60){
    const ratio = (studySamples/samples)*100;
    const th = clamp(Number(ui.presence.value)||70, 50, 100);
    if (ratio >= th){
      totalMinutes++;
      unsentMinutes++;
      localStorage.setItem('totalMinutes',  String(totalMinutes));
      localStorage.setItem('unsentMinutes', String(unsentMinutes));
      syncMinutePills();
      log(`+1分（勉強フレーム率 ${ratio.toFixed(0)}% >= しきい値 ${th}%）`);
    }else{
      log(`加算なし（勉強フレーム率 ${ratio.toFixed(0)}% < しきい値 ${th}%）`);
    }
    samples=0; studySamples=0;
  }
}

/* ========== 送信（デフォ1分ごと） ========== */
function scheduleFlush(){
  const mins = clamp(Number(ui.flush.value)||1, 1, 30);
  if (flushTimer) clearInterval(flushTimer);
  flushTimer = setInterval(()=>flushReport(false), mins*60*1000);
}
async function flushReport(force){
  const minutes = unsentMinutes;              // 未送信分だけ送る
  if (!minutes && !force) return;

  const payload = { type:'study-minutes-report', minutes, ts:new Date().toISOString(), ua:navigator.userAgent };
  try{
    // プリフライト回避（text/plain）＋失敗時no-cors保険
    await fetch(GAS_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body: JSON.stringify(payload),
      keepalive: true
    }).catch(async ()=>{
      await fetch(GAS_ENDPOINT, { method:'POST', mode:'no-cors', body: JSON.stringify(payload), keepalive:true });
    });

    log(`送信: ${minutes} 分`);
    // 表示用の totalMinutes は維持、未送信バッファだけリセット
    unsentMinutes = 0;
    localStorage.setItem('unsentMinutes','0');
    syncMinutePills();
  }catch(e){
    log('送信失敗: ' + (e?.message||e) + '（次回再送）');
  }
}

/* ========== Wake Lock ========== */
async function requestWakeLock(){ if('wakeLock' in navigator){ try{ wakeLock = await navigator.wakeLock.request('screen'); }catch{} } }
async function releaseWakeLock(){ try { if (wakeLock) await wakeLock.release(); } catch {} }

/* ========== ヘルパ ========== */
function setState(active){
  const txt = active?'監視中':'停止中';
  const cls = 'pill ' + (active?'ok':'ng');
  ui.statePill.textContent=txt; ui.statePill.className=cls;
  ui.statePill_fs.textContent=txt; ui.statePill_fs.className=cls;
}
function setPill(el, label, on){ el.textContent = `${label}: ${on?'検出':'未検出'}`; el.className='pill '+(on?'ok':'ng'); }
function syncMinutePills(){
  const t=`勉強分: ${totalMinutes}`;
  ui.minutePill.textContent=t;
  ui.minutePill_fs.textContent=t;
}
function log(s){ ui.log.textContent += `[${new Date().toLocaleTimeString()}] ${s}\n`; }
function clamp(v,lo,hi){ return Math.max(lo, Math.min(hi,v)); }
function showToast(msg){ ui.toast.textContent=msg; ui.toast.classList.add('show'); setTimeout(()=>ui.toast.classList.remove('show'), 3000); }

/* 背景化での自動停止はオフ（誤停止しがち） */
// document.addEventListener('visibilitychange', ()=>{ if(document.hidden && running){ log('背景化→停止'); stop(); }});
</script>

<!-- 依存スクリプト（CDNから動的ロード。HTMLへ直書きしない方針） -->
</body>
</html>
